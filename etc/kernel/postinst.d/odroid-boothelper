#!/bin/sh -e

version="$1"

# FIXME: The board specific device symbol to be more generic
#        or can be obtained from the board itself.
device=odroidxu4

zimage=vmlinuz-${version}
uinitrd=uInitrd-${version}
devicetree=exynos5422-${device}-${version}.dtb

initrd_addr=0x42000000

cp -f /lib/modules/${version}/boot/${zimage} /boot
cp -f /lib/modules/${version}/boot/${devicetree} /boot

mkimage -A arm -O linux -T ramdisk -C gzip \
        -a ${initrd_addr} -e ${initrd_addr} -n uInitrd \
        -d /boot/initrd.img-${version} /boot/${uinitrd}

if [ ! -f /boot/boot.ini ]; then
        cat>/boot/boot.ini<<__EOF
ODROIDXU-UBOOT-CONFIG

# U-Boot Parameters (DO NOT MODIFY)
setenv version
setenv zimage vmlinuz-\${version}
setenv uinitrd uInitrd-\${version}
setenv devicetree exynos5422-${device}-\${version}.dtb

setenv initrd_high "0xffffffff"
setenv fdt_high "0xffffffff"

# Default boot argument
setenv bootrootfs "console=ttySAC2,115200n8 root=/dev/mmcblk0p2 rootwait ro"

# boot commands
setenv bootcmd "fatload mmc 0:1 0x40008000 \${zimage}; fatload mmc 0:1 ${initrd_addr} \${uinitrd}; fatload mmc 0:1 0x44000000 \${devicetree}; bootz 0x40008000 ${initrd_addr} 0x44000000"
setenv bootargs "\${bootrootfs}"

boot
__EOF
fi

sed -i "s/^setenv version/setenv version ${version}/g" /boot/boot.ini
